<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>CodeSearch——代码检索插件 | Xinrui Zhang</title>

  
  <meta name="author" content="Xinrui Zhang">
  

  
  <meta name="description" content="CodeSearch——代码检索插件项目背景在我们的项目中，常常会复用代码，而如果对已有代码不够熟悉，则很容易产生重复造轮子的情况。针对这样的情况，本项目旨在汇总已有代码组件、工具方法，使用信息检索的相关技术，实现一款能够根据功能检索代码的 vscode 插件，以方便大家的日常开发，减少重复造轮子的">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="CodeSearch——代码检索插件"/>

  <meta property="og:site_name" content="Xinrui Zhang"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Xinrui Zhang" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Xinrui Zhang</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>CodeSearch——代码检索插件</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/08/26/CodeSearch/" rel="bookmark">
        <time class="entry-date published" datetime="2021-08-26T08:08:08.000Z">
          2021-08-26
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="CodeSearch——代码检索插件"><a href="#CodeSearch——代码检索插件" class="headerlink" title="CodeSearch——代码检索插件"></a>CodeSearch——代码检索插件</h1><h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>在我们的项目中，常常会复用代码，而如果对已有代码不够熟悉，则很容易产生重复造轮子的情况。针对这样的情况，本项目旨在汇总已有代码组件、工具方法，使用信息检索的相关技术，实现一款能够根据功能检索代码的 vscode 插件，以方便大家的日常开发，减少重复造轮子的情况，提高效率。</p>
<h2 id="项目内容"><a href="#项目内容" class="headerlink" title="项目内容"></a>项目内容</h2>

<h3 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h3><ol>
<li>下载打包后的.vsix 文件</li>
<li>将下载的文件放入 VScode 安装根目录的 extensions 文件夹中<br>文件夹路径参考：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows %USERPROFILE%\.vscode\extensions</span><br><span class="line">macOS ~/.vscode/extensions</span><br><span class="line">Linux ~/.vscode/extensions</span><br></pre></td></tr></table></figure></li>
<li>执行命令<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code <span class="literal">--install-extension</span> xxx.vsix</span><br></pre></td></tr></table></figure>
(建议 vsix 路径直接拖拽)</li>
<li>在 VScode 中调出命令搜索框，输入 code search，如存在此命令，则安装成功</li>
</ol>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><ol>
<li>在 VScode 中调出命令搜索框，输入或选择 code search</li>
<li>在接下来的下拉框中选择想要检索的范围</li>
<li>输入检索文本</li>
<li>查看检索结果</li>
</ol>
<h2 id="技术路线"><a href="#技术路线" class="headerlink" title="技术路线"></a>技术路线</h2><p>本节中仅是概括性介绍，详细描述请参考后续段落。</p>
<ol>
<li><p>typescript</p>
<p>用于 vscode 插件的开发。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://code.visualstudio.com/api">ms 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Microsoft/vscode-extension-samples">ms 官方提供插件开发示例</a></li>
<li><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/">typescript 使用手册</a></li>
</ul>
</li>
<li><p>elastic search</p>
<p>用于检索功能的实现。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/index.html">elastic search 官方文档</a></li>
</ul>
</li>
<li><p>electron</p>
<p>用于数据导入桌面程序的实现</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.electronjs.org/docs/latest/">electron 官方文档</a></li>
</ul>
</li>
</ol>
<h2 id="特色与创新点"><a href="#特色与创新点" class="headerlink" title="特色与创新点"></a>特色与创新点</h2><ol>
<li>比起传统的搜索引擎，本项目的数据集对于与本组项目更有针对性，整合、汇总了本组已有资源，能更好地提高效率，并提供了加入个性化数据的服务。</li>
<li>相比于 VScode 已有的搜索功能，本插件在使用场景与功能上存在以下特点：<ol>
<li>VScode 搜索功能是针对本工作区内文件进行查找，适用于希望找到当前项目中某个变量、函数、代码段的场景；而本插件的检索数据集来源于本组多个项目的公共组件、工具函数，适用于在代码编写过程中，希望查找能实现某个功能的轮子的场景。</li>
<li>VScode 搜索功能对搜索结果的排序并无特殊处理，而本插件将根据计算得到的相关度进行排序(具体公式参见下文)</li>
</ol>
</li>
<li>本项目在数据采集的过程中，加入了对数据的分析、处理、可视化展示</li>
</ol>
<h2 id="所用技术介绍"><a href="#所用技术介绍" class="headerlink" title="所用技术介绍"></a>所用技术介绍</h2><h3 id="VScode-插件开发"><a href="#VScode-插件开发" class="headerlink" title="VScode 插件开发"></a>VScode 插件开发</h3><h4 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h4><p>根据接下来的步骤，我们可以创建一个使用命令激活，输出 hello world 的插件</p>
<ol>
<li><p>安装 Yeoman 和 VS code generator</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yo generator-code</span><br></pre></td></tr></table></figure>

<p>脚手架——用于自动生成 VScode 插件模板项目</p>
</li>
<li><p>生成模板项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yo code</span><br></pre></td></tr></table></figure>

<p>根据需要进行选择(若为首次尝试，可根据下列选项一路回车)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">? What <span class="built_in">type</span> of extension <span class="keyword">do</span> you want to create? New Extension (TypeScript)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">? What<span class="string">&#x27;s the name of your extension? HelloWorld</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">## Press &lt;Enter&gt; to choose default for all options below ###</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">? What&#x27;</span>s the identifier of your extension? helloworld</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">? What<span class="string">&#x27;s the description of your extension? LEAVE BLANK</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">? Initialize a git repository? Yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">? Bundle the source code with webpack? No</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">? Which package manager to use? npm</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>运行<br>打开刚刚创建好的项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code ./helloworld</span><br></pre></td></tr></table></figure>

<p>F5 运行项目调试</p>
<ul>
<li>此时将打开一个新的 VScode 窗口用于插件调试，用于调试的窗口标题栏会标注”[Extension Development Host]”便于区分</li>
</ul>
<p>⬆+command+P 打开命令搜索框，输入 hello world，运行相关命令</p>


<p>在右下角看到弹出的通知框，即为命令运行成功，插件已激活</p>
</li>
</ol>
<h4 id="模板项目解析"><a href="#模板项目解析" class="headerlink" title="模板项目解析"></a>模板项目解析</h4><p>根据上一节的步骤，我们成功创建了一个 VScode 插件，接下来，来看看这个项目中的结构与具体实现吧。</p>
<h5 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── .vscode</span><br><span class="line">│   ├── launch.json     // 插件加载和调试的配置</span><br><span class="line">│   └── tasks.json      // 配置TypeScript编译任务</span><br><span class="line">├── .gitignore          // 忽略构建输出和node_modules文件</span><br><span class="line">├── README.md           // 一个友好的插件文档</span><br><span class="line">├── src</span><br><span class="line">│   └── extension.ts    // 插件源代码</span><br><span class="line">├── package.json        // 插件配置清单</span><br><span class="line">├── tsconfig.json       // TypeScript配置</span><br></pre></td></tr></table></figure>

<p>针对基本功能的开发，我们目前只需要关注<em>package.json</em>和<em>extension.ts</em>这两个文件，如果你对其他配置文件感兴趣，可以查看 VScode 的<a target="_blank" rel="noopener" href="https://code.visualstudio.com/api">官方文档</a> 和 TypeScript 的<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/">官方使用手册</a>。</p>
<h5 id="插件配置清单-package-json"><a href="#插件配置清单-package-json" class="headerlink" title="插件配置清单-package.json"></a>插件配置清单-package.json</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;helloworld&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HelloWorld&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vscode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.58.0&quot;</span> <span class="comment">// 这里指定了插件运行所需的VScode版本</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;categories&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;Other&quot;</span> <span class="comment">// 插件类型(具体见下一节介绍)</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;activationEvents&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;onCommand:helloworld.helloWorld&quot;</span> <span class="comment">// 绑定激活事件</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./out/extension.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;contributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="comment">// 定义、发布命令helloworld.helloworld</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;helloworld.helloWorld&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vscode:prepublish&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run compile&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tsc -p ./&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;watch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tsc -watch -p ./&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pretest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run compile &amp;&amp; npm run lint&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eslint src --ext ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node ./out/test/runTest.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@types/vscode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.58.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@types/glob&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^7.1.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@types/mocha&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^8.2.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@types/node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;14.x&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eslint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^7.27.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/eslint-plugin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.26.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/parser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.26.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;glob&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^7.1.7&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mocha&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.3.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vscode-test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.5.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="源代码-extension-ts"><a href="#源代码-extension-ts" class="headerlink" title="源代码-extension.ts"></a>源代码-extension.ts</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The module &#x27;vscode&#x27; contains the VS Code extensibility API</span></span><br><span class="line"><span class="comment">// Import the module and reference it with the alias vscode in your code below</span></span><br><span class="line"><span class="comment">// 引入VScode提供的API</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> vscode <span class="keyword">from</span> <span class="string">&quot;vscode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this method is called when your extension is activated</span></span><br><span class="line"><span class="comment">// your extension is activated the very first time the command is executed</span></span><br><span class="line"><span class="comment">// 当插件激活时执行此函数，激活条件即为package.json中注册的命令执行</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">activate</span>(<span class="params">context: vscode.ExtensionContext</span>) &#123;</span><br><span class="line">  <span class="comment">// Use the console to output diagnostic information (console.log) and errors (console.error)</span></span><br><span class="line">  <span class="comment">// This line of code will only be executed once when your extension is activated</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Congratulations, your extension &quot;helloworld&quot; is now active!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The command has been defined in the package.json file</span></span><br><span class="line">  <span class="comment">// Now provide the implementation of the command with registerCommand</span></span><br><span class="line">  <span class="comment">// The commandId parameter must match the command field in package.json</span></span><br><span class="line">  <span class="comment">// 将package.json中定义的命令与对应事件注册绑定</span></span><br><span class="line">  <span class="keyword">let</span> disposable = vscode.<span class="property">commands</span>.<span class="title function_">registerCommand</span>(<span class="string">&quot;helloworld.helloWorld&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// The code you place here will be executed every time your command is executed</span></span><br><span class="line">    <span class="comment">// Display a message box to the user</span></span><br><span class="line">    <span class="comment">// 在右下角显示通知框</span></span><br><span class="line">    vscode.<span class="property">window</span>.<span class="title function_">showInformationMessage</span>(<span class="string">&quot;Hello World from HelloWorld!&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  context.<span class="property">subscriptions</span>.<span class="title function_">push</span>(disposable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this method is called when your extension is deactivated</span></span><br><span class="line"><span class="comment">// 在插件停用前执行</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">deactivate</span>(<span class="params"></span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>最后，让我们来梳理一下，首先你需要在 package.json 中定义你将用到的命令，并注册能够激活组件的命令，如：输入命令”hello world”、打开 JavaScript 文件、按下组合按键等；接下来，在 extension.ts 的 activate 函数中将你定义的命令与将插件激活后命令触发的函数绑定起来，并在 deactivate 函数中进行插件停用前的清除，这样就可以实现一个简单的插件啦～</p>
<h4 id="插件功能"><a href="#插件功能" class="headerlink" title="插件功能"></a>插件功能</h4><p>上一节中，我们对 VScode 插件的结构进行了解析，几乎所有的插件都是根据这样的结构来进行开发的，本节中，我们将介绍 VScode 为哪些功能提供了可扩展的 API</p>


<p>VScode 插件可提供的功能主要为以上五类：</p>
<p>首先是通用的如选择文件、文件夹，收集用户输入，存储工作区或全局数据等基本的功能；</p>
<p>其次是主题相关的，如源代码颜色设置，UI 主题设置，icon 图标设置等；</p>
<p>第三是语言特性，分为声明式与程序式，声明式主要是文本编辑基础的特性，不包含代码逻辑，如括号匹配显示、自动缩进、语法高亮等，而程序式则需要结合程序语言逻辑，如悬停提示、跳转定义、格式化等；</p>
<p>第四是工作台 UI 的扩展，可以增加右键菜单、状态栏、侧边栏、webview 等，具体对应关系见下图；</p>


<p>最后，是调试相关的功能，可以利用 VScode 提供的调试功能或自己的调试功能来进行开发。</p>
<p>以上仅为各类插件功能的概要介绍，具体的 API 见<a target="_blank" rel="noopener" href="https://code.visualstudio.com/api/references/vscode-api#working-with-extensions-articles">官方文档</a></p>
<h4 id="VScode-命令系统"><a href="#VScode-命令系统" class="headerlink" title="VScode 命令系统"></a>VScode 命令系统</h4><p>VScode 是微软使用 electron 框架，100%TypeScript 语言开发的桌面端代码编辑器软件，我们能够依照规范自由添加插件，主要源于其平台/插件架构风格的设计，下面将对 VScode 的设计做简要介绍</p>


<p>VScode 采用多进程架构，上图为简要展示，</p>
<ul>
<li>主进程：VSCode 的入口进程，负责如窗口管理、进程间通信、自动更新等全局任务</li>
<li>渲染进程：负责一个 Web 页面的渲染</li>
<li>插件宿主进程：每个插件的代码都会运行在一个独属于自己的 NodeJS 环境的宿主进程中，插件不允许访问 UI</li>
<li>Debug 进程：Debugger 相比普通插件做了特殊化</li>
<li>Search 进程：搜索是一类计算密集型的任务，单开进程保证软件整体体验与性能</li>
</ul>


<p>如上图，VScode 选取的命令系统相较网状的结构更为扁平，能够更加高效地进行功能的调用。</p>
<h3 id="Elastic-Search-与信息检索"><a href="#Elastic-Search-与信息检索" class="headerlink" title="Elastic Search 与信息检索"></a>Elastic Search 与信息检索</h3><p>本节将根据 elastic search 的原理，按照信息检索的一般流程对信息检索进行简要的介绍，旨在从较高层面了解大致流程，不会过多深入细节和具体实现。</p>
<h4 id="数据采集"><a href="#数据采集" class="headerlink" title="数据采集"></a>数据采集</h4><p>这一步是为后续的检索提供用于搜索的语料数据，并做预先的处理。</p>
<ol>
<li><p>使用爬虫相关技术收集所需数据</p>
</li>
<li><p>数据清洗</p>
<ul>
<li>去除空数据</li>
<li>去除重复数据</li>
<li>去除明显错误的数据</li>
</ul>
</li>
<li><p>构建停词表、叙词表</p>
<ul>
<li><p>停词表</p>
<p>无意义的标点、符号、字词等</p>
<p><a target="_blank" rel="noopener" href="https://github.com/goto456/stopwords">中文常用停词表</a></p>
</li>
<li><p>叙词表</p>


<p>主要为同义词表</p>
</li>
</ul>
</li>
<li><p>中文分词</p>
<p>由于中文没有自然的分隔符，相较于英文分词，难度更大，更易产生歧义，常使用字典、隐马尔可夫模型、机器学习等方法，不是本文的重点，故不做具体介绍。</p>
</li>
</ol>
<h4 id="建立倒排索引"><a href="#建立倒排索引" class="headerlink" title="建立倒排索引"></a>建立倒排索引</h4><p>倒排索引是实现高效索引的关键，经过分词处理后得到的项作为 term 项，每项对应其所在文档编号的 postings list 倒排索引，如下图(例子中为方便举例，直接划分至字，没有进行分词)</p>


<p>同时，为了更高效地对 term 项进行检索，elastic search 采取了<a target="_blank" rel="noopener" href="https://www.shenyanchao.cn/blog/2018/12/04/lucene-fst/">FST</a>的结构，FST(Finite State Transducer)类似于 TRIE 树的结构，各 term 项可共用相同的前缀或后缀，但不同的 term 项到达结尾计算到的数值不同。</p>


<p>下图即为完整的 term dict index 词典索引树、term dict 词典、invert index 倒排索引的大致结构。</p>


<h5 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h5><p>对于大规模的信息检索，其数据量往往会达到十分庞大的程度，此时能否高效地存取也是影响检索效率的一个重要因素。针对这一问题，elastic search 采取了下列两种方法进行磁盘压缩存储与缓存查询优化。</p>
<ol>
<li><p>Frame of Reference</p>
<p>此方法流程如下图，首先将文档列表处理为增量列表，然后将其划分为大小为 256 的块，然后进行按需分配，这里每块的第一位将记录块内各项所需的位数，之后各项根据最大项所需的位数存储。这样，就实现了压缩存储的倒排索引。</p>
</li>
<li><p>Roaring Bitmaps</p>
<p>上述的 Frame of Reference 方法很好地解决了倒排索引在磁盘中的存储问题，而对于分块存储的倒排索引来说，需要频繁的求并集，面对多条件查询时还需要进行交集操作，对于快速的交并集操作，elastic search 采用了 Roaring Bitmaps 的方法，在缓存中进行压缩。</p>
<p>在介绍 Roaring Bitmaps 之前，我们先来介绍两种压缩方法：</p>
<ol>
<li><p>数组</p>
<p>也就是直接使用原始的文档 ID，进行数组操作，但这种方法显然不适合 elastic search 每次计算的数据量。</p>
</li>
<li><p>Bitmap</p>
<p>Bitmap 是一个常用的数据结构，我们通过一个例子来了解一下他的结构，我们现在有[2,3,5]和[1,3,4,5]两个数组，将其使用 Bitmap 来表示即为[0,0,1,1,0,1]和[0,1,0,1,1,1]，也就是原数组中的值所对应的 Bitmap 中相应脚标的值为 1，其余为 0。这样如果我们要对两个数组取交集，那么我们就对他们的 Bitmap 做与运算，取并集，就做或运算。</p>
</li>
</ol>
<p>我们看到 Bitmap 比较好地完成了对数组的压缩，无论原文档列表中各项的大小是多少，在 bitmap 中都只需要用一位的 0 或 1 来表示。事实上，相当长一段时间内，elastic search 都是采用这种方法的，直到 lucene5 开始使用 Roaring Bitmaps，这主要是为了解决 Bitmap 在稀疏情况下造成的空间浪费。</p>
<p>对于文档列表，使用 N/65536 得到该文档对应的块号，然后使用 N%65536 得到该文档在块内的 id，接下来根据不同的块号将文档分配的所属的块，最后根据块内文档数进行数组或位图的选择，这里的阈值来源于实际数据，当超过 4096 时选用位图，反之选用数组。</p>
</li>
</ol>
<h4 id="相关度计算"><a href="#相关度计算" class="headerlink" title="相关度计算"></a>相关度计算</h4><p>倒排索引让我们能够快速找到包含检索词的文档，但是当相关文档很多时，如果直接按照存储顺序呈现给用户，往往不会带来比较好的体验，我们需要计算文档与检索词的相关度，将最符合用户检索需求的结果排在靠前的位置。</p>
<p>为了进行相关度的计算，让我们先来了解几个参数</p>
<p>$$<br>词频：tf_{t \in d} = \sqrt{frequency}<br>$$</p>
<p>$$<br>逆向文档频率：idf_t = 1 + \log(\frac{numDocs}{docFreq+1})<br>$$</p>
<p>$$<br>字段长度归一值：norm_d = \frac{1}{\sqrt{numTerms}}<br>$$</p>
<p>其中：</p>
<ul>
<li>$frequency$代表词 t 在文档 d 中出现的次数</li>
<li>$numDocs$代表索引中文档数量</li>
<li>$docFreq$代表包含词 t 的文档数</li>
<li>$numTerms$代表所在字段的词数</li>
</ul>
<p>由此，相关度计算公式如下：</p>
<p>$$<br>score_{q,d} = coord_{(q,d)} * \sum_{t \in q}{tf_{t \in d} * idf_{t}^2 * Boost * norm_{(t,d)}}<br>$$</p>
<p>其中，$coord_{(q,d)}$为$\frac{文档中包含的查询词数}{查询词总数}$，$Boost$为设定参数</p>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>上一节中，我们已经根据词频等数据计算得到了各篇文档的相关度，接下来需要对其进行排序，大量数据表明，按相关度降序排序后的前 20 条结果可以满足大多数用户的一般查询需求。因此，通常情况下我们不需要将全部查询结果返回给用户，只需要将前 K 个最符合查询需求的记录返回给用户即可，这里的 K 通常为 20。</p>
<p>这也就是十分常见的<a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/">topK 问题</a>，最基础的解法是将全部数据进行排序，然后取其前 K 个，但这种方法复杂度较高，在数据量比较大的时候并不适用。</p>
<p>一般来讲，我们采用最大堆/最小堆的方法，我们维护一个有前 k 个最大值构成的小顶堆，每拿到一个数据，就将其与堆顶数据比较，如果大于堆顶数据，则将堆顶数据删除，将新数据插入，反之则不做处理，这样当对全部数据遍历一遍后，堆中数据即为前 k 个最大值。若使用大顶堆，则开始遍历前对全部数据取反即可。</p>
<p>还可以使用快排的思想来解决 topK 问题，但其实现相对堆方法比较复杂，故本文不做介绍，感兴趣的朋友可以自行探索。</p>
<h3 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h3><p>注：本仓库为 private，如对源码感兴趣可以联系作者开放权限。</p>
<p>VScode 官方文档：<a target="_blank" rel="noopener" href="https://code.visualstudio.com/api">https://code.visualstudio.com/api</a></p>
<p>VScode 源码：<a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode">https://github.com/microsoft/vscode</a></p>
<p>MS 官方插件示例项目：<a target="_blank" rel="noopener" href="https://github.com/Microsoft/vscode-extension-samples">https://github.com/Microsoft/vscode-extension-samples</a></p>
<p>TypeScript 官方文档：<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/">https://www.typescriptlang.org/docs/</a></p>
<p>TypeScript 类型体操：<a target="_blank" rel="noopener" href="https://github.com/type-challenges/type-challenges">https://github.com/type-challenges/type-challenges</a></p>
<p>Elastic Search 官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/index.html">https://www.elastic.co/guide/index.html</a></p>
<p>常用中文停词表：<a target="_blank" rel="noopener" href="https://github.com/goto456/stopwords">https://github.com/goto456/stopwords</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 Xinrui Zhang
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>